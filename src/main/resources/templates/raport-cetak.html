<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raport Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @page { 
      size: A4; 
      margin: 15mm;
    }
    @media print {
      body { 
        background: #fff !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .no-print { display: none !important; }
      .print-border { border: 2px solid #1e40af !important; }
      .print-bg { background: #f8fafc !important; }
      .print-header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important; }
      .shadow-md { box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important; }
      .shadow-lg { box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
    }
    .raport-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      position: relative;
      overflow: hidden;
    }
    .raport-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    .raport-header::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 200px;
      height: 200px;
      background: rgba(255,255,255,0.08);
      border-radius: 50%;
    }
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-left: 4px solid;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .grade-badge {
      font-weight: 700;
      letter-spacing: 0.5px;
      min-width: 60px;
      text-align: center;
    }
    .signature-line {
      border-top: 2px solid #1e40af;
      margin-top: 80px;
      padding-top: 8px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 text-gray-800">
  <div class="max-w-5xl mx-auto p-8 print:p-0">
    <!-- Header Raport -->
    <div class="raport-header text-white p-8 rounded-t-3xl shadow-2xl mb-8 print-header print-border relative z-10">
      <div class="flex items-center justify-between relative z-20">
        <div class="flex items-center gap-4">
          <div class="bg-white/20 backdrop-blur-sm p-4 rounded-2xl">
            <i class="fa-solid fa-graduation-cap text-4xl"></i>
          </div>
          <div>
            <div class="text-3xl font-bold tracking-tight mb-1">RAPORT SISWA</div>
            <div class="text-lg font-medium opacity-90" th:text="${siswa != null and siswa.nama != null ? siswa.nama : 'Nama Siswa'}">Nama Siswa</div>
            <div class="text-sm opacity-75 mt-1" th:text="${siswa != null and siswa.nis != null ? 'NIS: ' + siswa.nis : ''}">NIS: -</div>
          </div>
        </div>
        <button th:if="${allowedMenu != null and (allowedMenu == 'admin' or allowedMenu == 'siswa' or allowedMenu == 'all')}" 
                type="button" onclick="window.print()" class="no-print bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white px-6 py-3 rounded-xl border border-white/30 transition-all flex items-center gap-2 font-medium">
          <i class="fa-solid fa-print"></i>
          <span>Cetak</span>
        </button>
      </div>
    </div>

    <!-- Informasi Siswa & Statistik -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Card Informasi Siswa -->
      <div class="stat-card border-l-blue-500 p-6 rounded-xl shadow-lg print-bg print-border">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-blue-100 p-3 rounded-lg">
            <i class="fa-solid fa-user-graduate text-blue-600 text-xl"></i>
          </div>
          <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Informasi Siswa</div>
        </div>
        <div class="space-y-3">
          <div>
            <div class="text-xs text-gray-500 mb-1">Nomor Induk Siswa</div>
            <div class="text-xl font-bold text-gray-800" th:text="${siswa != null and siswa.nis != null ? siswa.nis : '-'}">-</div>
          </div>
          <div class="pt-3 border-t border-gray-200">
            <div class="text-xs text-gray-500 mb-1">Kelas</div>
            <div class="text-xl font-bold text-gray-800" th:text="${siswa != null and siswa.kelas != null ? siswa.kelas : '-'}">-</div>
          </div>
        </div>
      </div>

      <!-- Card Rata-rata Nilai -->
      <div class="stat-card border-l-green-500 p-6 rounded-xl shadow-lg print-bg print-border">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="fa-solid fa-star text-green-600 text-xl"></i>
          </div>
          <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Rata-rata Nilai</div>
        </div>
        <div class="text-center">
          <div class="text-5xl font-bold text-green-600 mb-3" th:text="${rataRata != null ? #numbers.formatDecimal(rataRata, 1, 1) : '0.0'}">0.0</div>
          <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
            <div class="h-full rounded-full bg-gradient-to-r from-green-500 to-green-400 transition-all duration-500" 
                 th:style="${'width:' + (rataRata != null ? (rataRata > 100 ? 100 : rataRata) : 0) + '%'}"></div>
          </div>
          <div class="mt-2 text-xs text-gray-600" th:text="${rataRata != null ? #numbers.formatDecimal(rataRata, 1, 1) + ' dari 100' : '0.0 dari 100'}">0.0 dari 100</div>
        </div>
      </div>

      <!-- Card Status Kenaikan -->
      <div class="stat-card border-l-purple-500 p-6 rounded-xl shadow-lg print-bg print-border">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-purple-100 p-3 rounded-lg">
            <i class="fa-solid fa-chart-line text-purple-600 text-xl"></i>
          </div>
          <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Status Kenaikan</div>
        </div>
        <div class="space-y-4">
          <div class="text-center">
            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-bold"
                 th:class="${raportTerbaru != null and raportTerbaru.statusKenaikanKelas == 'Naik'} ? 'bg-green-100 text-green-700 border-2 border-green-300' : 'bg-red-100 text-red-700 border-2 border-red-300'">
              <i class="fa-solid fa-arrow-up" th:if="${raportTerbaru != null and raportTerbaru.statusKenaikanKelas == 'Naik'}"></i>
              <i class="fa-solid fa-arrow-down" th:if="${raportTerbaru == null or raportTerbaru.statusKenaikanKelas != 'Naik'}"></i>
              <span th:text="${raportTerbaru != null ? raportTerbaru.statusKenaikanKelas : 'Tidak Naik'}">Status</span>
            </div>
          </div>
          <div>
            <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full rounded-full transition-all duration-500"
                   th:class="${persenLulus >= 75} ? 'bg-gradient-to-r from-green-500 to-green-400' : 'bg-gradient-to-r from-red-500 to-red-400'"
                 th:style="${'width:' + persenLulus + '%'}"></div>
            </div>
            <div class="mt-2 text-xs text-center text-gray-600 font-medium" 
                 th:text="${passCount + ' dari ' + totalMapel + ' mapel lulus (' + #numbers.formatDecimal(persenLulus, 1, 1) + '%)'}">0 dari 0 mapel</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabel Nilai Mata Pelajaran -->
    <div class="mb-10 print-bg print-border rounded-xl shadow-lg overflow-hidden">
      <div class="bg-gradient-to-r from-blue-600 to-blue-500 text-white p-5">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-book-open text-2xl"></i>
          <h2 class="text-2xl font-bold">Nilai Mata Pelajaran</h2>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-blue-50">
          <tr>
              <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-blue-200">No</th>
              <th class="px-6 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-blue-200">Mata Pelajaran</th>
              <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-blue-200">Nilai</th>
              <th class="px-6 py-4 text-center text-sm font-bold text-gray-700 uppercase tracking-wider border-b-2 border-blue-200">Predikat</th>
          </tr>
        </thead>
          <tbody class="divide-y divide-gray-200">
            <tr th:if="${nilai == null or nilai.isEmpty()}" class="bg-white">
              <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                <i class="fa-solid fa-inbox text-3xl text-gray-300 mb-2 block"></i>
                <p>Belum ada nilai</p>
              </td>
            </tr>
            <tr th:each="e, i : ${nilai}" class="bg-white hover:bg-blue-50 transition-colors">
              <td class="px-6 py-4 text-gray-700 font-semibold" th:text="${i.index + 1}">1</td>
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="bg-blue-100 p-2 rounded-lg">
                    <i class="fa-solid fa-book text-blue-600"></i>
                  </div>
                  <div class="font-semibold text-gray-800" th:text="${mapelNames != null ? mapelNames[e.key.idMataPelajaran] : e.key.nama}">Mata Pelajaran</div>
                </div>
            </td>
              <td class="px-6 py-4 text-center">
                <span class="grade-badge inline-flex items-center justify-center px-4 py-2 rounded-xl text-lg font-bold border-2"
                      th:class="${'grade-badge inline-flex items-center justify-center px-4 py-2 rounded-xl text-lg font-bold border-2 ' + (e.value >= 85 ? 'bg-green-100 text-green-700 border-green-300' : (e.value >= 75 ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : (e.value >= 65 ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-red-100 text-red-700 border-red-300')))}"
                    th:text="${e.value}">90</span>
            </td>
              <td class="px-6 py-4 text-center">
                <span class="text-sm font-semibold uppercase">
                <span th:if="${e.value >= 85}" class="text-green-700">Sangat Baik</span>
                <span th:if="${e.value >= 75 and e.value < 85}" class="text-yellow-700">Baik</span>
                <span th:if="${e.value >= 65 and e.value < 75}" class="text-orange-700">Cukup</span>
                <span th:if="${e.value < 65}" class="text-red-700">Kurang</span>
              </span>
              </td>
          </tr>
        </tbody>
      </table>
      </div>
    </div>

    <!-- Catatan Wali Kelas -->
    <div class="mb-8 print-bg print-border rounded-xl shadow-lg overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white p-5">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-comment-dots text-2xl"></i>
          <h2 class="text-2xl font-bold">Catatan Wali Kelas</h2>
        </div>
      </div>
      <div class="p-6 bg-white min-h-[120px]">
        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap" th:text="${raportTerbaru != null and raportTerbaru.catatanWaliKelas != null ? raportTerbaru.catatanWaliKelas : 'Tidak ada catatan'}">Tidak ada catatan</p>
      </div>
    </div>

    <!-- Tanda Tangan -->
    <div class="mt-12 grid grid-cols-2 gap-12 print:mt-8">
      <div class="text-center">
        <div class="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">Wali Kelas</div>
        <div class="signature-line">
          <div class="font-bold text-lg text-gray-800 mb-1">
            <span th:if="${waliKelas != null and waliKelas.nama != null and !waliKelas.nama.isEmpty()}" th:text="${waliKelas.nama}">Nama Wali Kelas</span>
            <span th:unless="${waliKelas != null and waliKelas.nama != null and !waliKelas.nama.isEmpty()}">____________________</span>
          </div>
          <div class="text-xs text-gray-500" th:text="${raportTerbaru != null ? #dates.format(raportTerbaru.tanggalDiterbitkan,'dd MMMM yyyy') : ''}">Tanggal</div>
        </div>
      </div>
      <div class="text-center">
        <div class="text-sm font-semibold text-gray-600 mb-2 uppercase tracking-wide">Kepala Sekolah</div>
        <div class="signature-line">
          <div class="font-bold text-lg text-gray-800 mb-1">____________________</div>
          <div class="text-xs text-gray-500" th:text="${raportTerbaru != null ? #dates.format(raportTerbaru.tanggalDiterbitkan,'dd MMMM yyyy') : ''}">Tanggal</div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-xs text-gray-500 no-print">
      <p>Raport ini dicetak secara digital pada <span th:text="${#dates.format(#dates.createNow(), 'dd MMMM yyyy HH:mm')}"></span></p>
    </div>
  </div>
</body>
</html>