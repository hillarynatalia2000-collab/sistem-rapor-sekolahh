<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nilai Siswa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/person.css}">
</head>
<body class="bg-gray-50 text-gray-800" th:attr="data-success=${success},data-error=${error}">
  <div th:replace="~{navigasi :: nav}"></div>
  <div class="max-w-7xl mx-auto p-6 pt-24">
    
    <div class="flex items-center gap-3 mb-6">
      <i class="fa-solid fa-chart-line text-[var(--brand)] text-2xl"></i>
      <h1 class="text-2xl font-semibold">Nilai dan Raport</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-6">
      <div th:replace="~{sidebar :: sidebar(false, ${allowedMenu})}"></div>
      
      <div class="space-y-6">
        <!-- Informasi Siswa -->
        <section class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-[var(--brand)]">
          <div class="flex items-center gap-2 mb-4">
            <i class="fa-solid fa-user-graduate text-gray-700"></i>
            <h2 class="text-lg font-semibold">Informasi Siswa</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-600 mb-1">Nama</label>
              <p class="text-lg font-semibold text-gray-800" th:text="${siswa.nama}">-</p>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">NIS</label>
              <p class="text-lg font-semibold text-gray-800" th:text="${siswa.nis != null ? siswa.nis : '-'}">-</p>
            </div>
            <div>
              <label class="block text-sm text-gray-600 mb-1">Kelas</label>
              <p class="text-lg font-semibold text-gray-800" th:text="${siswa.kelas != null ? siswa.kelas : '-'}">-</p>
            </div>
          </div>
        </section>

        <!-- Statistik Nilai -->
        <section th:if="${latestRaport != null and latestRaport.nilai != null and !latestRaport.nilai.isEmpty()}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <!-- Card Rata-rata Nilai -->
          <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-blue-500">
            <div class="flex items-center justify-between mb-2">
              <div class="p-3 bg-blue-100 rounded-lg">
                <i class="fa-solid fa-calculator text-blue-600 text-xl"></i>
              </div>
            </div>
            <h3 class="text-sm text-gray-600 mb-1">Rata-rata Nilai</h3>
            <p class="text-2xl font-bold text-gray-800" th:text="${#numbers.formatDecimal(rataRataNilai, 1, 2)}">0.0</p>
          </div>

          <!-- Card Total Mapel -->
          <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-green-500">
            <div class="flex items-center justify-between mb-2">
              <div class="p-3 bg-green-100 rounded-lg">
                <i class="fa-solid fa-book text-green-600 text-xl"></i>
              </div>
            </div>
            <h3 class="text-sm text-gray-600 mb-1">Total Mapel</h3>
            <p class="text-2xl font-bold text-gray-800" th:text="${totalMapel}">0</p>
          </div>

          <!-- Card Nilai Tertinggi -->
          <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-purple-500">
            <div class="flex items-center justify-between mb-2">
              <div class="p-3 bg-purple-100 rounded-lg">
                <i class="fa-solid fa-arrow-up text-purple-600 text-xl"></i>
              </div>
            </div>
            <h3 class="text-sm text-gray-600 mb-1">Nilai Tertinggi</h3>
            <p class="text-2xl font-bold text-gray-800" th:text="${nilaiTertinggi > 0 ? nilaiTertinggi : '-'}">-</p>
          </div>

          <!-- Card Nilai Terendah -->
          <div class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-orange-500">
            <div class="flex items-center justify-between mb-2">
              <div class="p-3 bg-orange-100 rounded-lg">
                <i class="fa-solid fa-arrow-down text-orange-600 text-xl"></i>
              </div>
            </div>
            <h3 class="text-sm text-gray-600 mb-1">Nilai Terendah</h3>
            <p class="text-2xl font-bold text-gray-800" th:text="${nilaiTerendah < 100 ? nilaiTerendah : '-'}">-</p>
          </div>
        </section>

        <!-- Raport Terbaru -->
        <section th:if="${latestRaport != null}" class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-green-500">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-file-lines text-gray-700"></i>
              <h2 class="text-lg font-semibold">Raport Terbaru</h2>
            </div>
            <a th:href="@{'/raport/cetak/' + ${siswa.id}}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--brand)] text-white hover:opacity-90">
              <i class="fa-solid fa-print"></i>
              <span>Cetak</span>
            </a>
          </div>
          
          <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm text-gray-600 mb-1">Nomor Raport</label>
                <p class="font-semibold text-gray-800" th:text="${latestRaport.nomorRapot != null ? latestRaport.nomorRapot : '-'}">-</p>
              </div>
              <div>
                <label class="block text-sm text-gray-600 mb-1">Tanggal Diterbitkan</label>
                <p class="font-semibold text-gray-800" th:text="${latestRaport.tanggalDiterbitkan != null ? #dates.format(latestRaport.tanggalDiterbitkan, 'dd MMMM yyyy') : '-'}">-</p>
              </div>
            </div>
            
            <!-- Nilai Mata Pelajaran -->
            <div th:if="${latestRaport.nilai != null and !latestRaport.nilai.isEmpty()}">
              <h3 class="text-md font-semibold mb-3">Nilai Mata Pelajaran</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">No</th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Mata Pelajaran</th>
                      <th class="px-4 py-2 text-center text-xs font-medium text-gray-600">Nilai</th>
                      <th class="px-4 py-2 text-center text-xs font-medium text-gray-600">Predikat</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200">
                    <tr th:each="e, i : ${latestRaport.nilai}" class="hover:bg-gray-50">
                      <td class="px-4 py-2" th:text="${i.index + 1}">1</td>
                      <td class="px-4 py-2" th:text="${e.key.nama}">Mata Pelajaran</td>
                      <td class="px-4 py-2 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold"
                              th:class="${'px-3 py-1 rounded-full text-sm font-semibold ' + (e.value >= 85 ? 'bg-green-100 text-green-700' : (e.value >= 75 ? 'bg-yellow-100 text-yellow-700' : (e.value >= 65 ? 'bg-orange-100 text-orange-700' : 'bg-red-100 text-red-700')))}"
                              th:text="${e.value}">90</span>
                      </td>
                      <td class="px-4 py-2 text-center">
                        <span class="text-sm font-semibold"
                              th:text="${e.value >= 85 ? 'A' : (e.value >= 75 ? 'B' : (e.value >= 65 ? 'C' : 'D'))}">A</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div th:if="${latestRaport.catatanWaliKelas != null and !latestRaport.catatanWaliKelas.isEmpty()}">
              <label class="block text-sm text-gray-600 mb-1">Catatan Wali Kelas</label>
              <p class="text-gray-800" th:text="${latestRaport.catatanWaliKelas}">-</p>
            </div>
          </div>
        </section>

        <!-- Daftar Semua Raport -->
        <section class="bg-white rounded-xl shadow-sm p-6 border-t-4 border-[var(--brand)]">
          <div class="flex items-center gap-2 mb-4">
            <i class="fa-solid fa-list text-gray-700"></i>
            <h2 class="text-lg font-semibold">Daftar Raport</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">No</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Nomor Raport</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-600">Tanggal Diterbitkan</th>
                  <th class="px-4 py-2 text-center text-xs font-medium text-gray-600">Aksi</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr th:if="${raportList == null or raportList.isEmpty()}" class="hover:bg-gray-50">
                  <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                      <i class="fa-solid fa-inbox text-4xl text-gray-300"></i>
                      <p class="text-sm">Belum ada raport</p>
                    </div>
                  </td>
                </tr>
                <tr th:each="r, i : ${raportList}" class="hover:bg-gray-50">
                  <td class="px-4 py-2" th:text="${i.index + 1}">1</td>
                  <td class="px-4 py-2" th:text="${r.nomorRapot != null ? r.nomorRapot : '-'}">-</td>
                  <td class="px-4 py-2" th:text="${r.tanggalDiterbitkan != null ? #dates.format(r.tanggalDiterbitkan, 'dd MMMM yyyy') : '-'}">-</td>
                  <td class="px-4 py-2 text-center">
                    <a th:href="@{'/raport/cetak/' + ${r.siswaId}}" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--brand)] text-white hover:opacity-90" title="Cetak">
                      <i class="fa-solid fa-print"></i>
                      <span>Cetak</span>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>
  <div th:replace="alert :: alerts"></div>
</body>
</html>

